---
title: "Fuel Economy Analysis"
author: "Jyoti Joshi"
date: "10/28/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Introduction

The dataset used in this analysis comes from https://www.fueleconomy.gov/feg/download.shtml. The particular file is https://www.fueleconomy.gov/feg/epadata/vehicles.csv.zip "Datasets for All Model Years (1984–2019)”.The data dictionary is here: https://www.fueleconomy.gov/feg/ws/index.shtml#vehicle

In this analysis, we are trying to find out which manufacturer produces the most efficient fleet of cars. Also, looking for some interesting trends or insights like how fuel economy changed over time.  

## Load Data 
```{r}
library(caret)
library(reshape2)
library(glm2)
library(corrplot)
library(ggplot2)
library(DataExplorer)
library(xtable)
library(car)
library(dplyr)
# library(randomForest)

setwd("/Users/jyoti/Project1/")
filepath <- "/Users/jyoti/Project1/vehicles.csv"
vehicles_data = read.csv(filepath)

```

## Exploratory Analysis

Explore the raw data by checking number of rows, columns, printing and plotting some content of variables and finding is there are any missing values.

```{r}
print(paste0(paste0("Number of rows of the raw dataset: ", nrow(vehicles_data)), paste0(" Number of columns of raw dataset: ", ncol(vehicles_data))))
names(vehicles_data)
head(vehicles_data)
# str(vehicles_data)
# summary(vehicles_data)
glimpse(vehicles_data)
hist(vehicles_data$cylinders)
plot(vehicles_data$fuelType1, vehicles_data$UCity)

#Find missing values in data
missing_values <- sapply(vehicles_data, function(x) sum(is.na(x)))
missing_values[missing_values >0]
```


## Subset and Clean Data

Looking at the data, the data dictionary and the problem statement, we can now select the features that we intuitively find relevant to the analysis. Below are the columns selected from dataset:

* ``cylinders'' - engine cylinders
* ``displ'' - engine displacement in liters
* ``drive'' - drive axle type
* ``feScore'' - EPA Fuel Economy Score (-1 = Not available)
* ``make'' - manufacturer (division)
* ``trany'' - transmission
* ``fuelType1'' - fuel type 1. For single fuel vehicles, this will be the only fuel. For dual fuel vehicles, this will be the conventional fuel 
* ``phevBlended'' - if true, this vehicle operates on a blend of gasoline and electricity in charge depleting mode
* ``VClass'' - EPA vehicle size class
* ``UCity'' - unadjusted city MPG for fuelType1
* ``year'' - model year

```{r}
required <- c('cylinders', 'displ', 'drive', 'feScore', 'make', 'trany', 'fuelType1', 'phevBlended', 'VClass', 'UCity', 'year')

#Subset the data to get desired features
vehicles_desired <- vehicles_data[, (names(vehicles_data) %in% required)]
# names(vehicles_desired)

#get count of NAs in feScore column (with value = -1)
sum(vehicles_desired$feScore==-1)
#drop feScore from features
vehicles_desired <- vehicles_desired[, !(names(vehicles_desired) %in% c("feScore"))]

#get rid of NAs from Cylinders and displ columns by dropping rows (since the NAs are few)
vehicles_desired <- vehicles_desired[complete.cases(vehicles_desired),] #This also gets rid of Electricity fueltype1 type

#Treating 0 UCity as bad data
sum(vehicles_desired$UCity==0)
#Drop rows with 0 Ucity
vehicles_desired <- vehicles_desired[!vehicles_desired$UCity==0,]

summary(vehicles_desired)

plot(vehicles_desired$fuelType1, vehicles_desired$UCity)
```


## Finding manufacturer with most fuel efficient fleet

```{r}
#Helper function for plotting multiple plots together
multiplot <- function(..., plotlist=NULL, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

To compare fuel efficiency among different car manufacturers, it only makes sense to do so over a particular model year. The following comparison thus is done for 2018 model year. Also, our data cleaning step excludes the 'Electricity' fueltype as it does not make sense to compare electric vehicle with other fuel type vehicles for MPG.

```{r}
#Subsetting for year 2018
vehicles_2018 <- vehicles_desired[vehicles_desired$year==2018,]

# mean(vehicles_2018$UCity)
mean_mpg_per_make <- aggregate(vehicles_2018$UCity, list(vehicles_2018$make), mean)
median_mpg_per_make <- aggregate(vehicles_2018$UCity, list(vehicles_2018$make), median)

top_mean <- mean_mpg_per_make[order(mean_mpg_per_make$x,decreasing=T)[1:3],]
top_median <- median_mpg_per_make[order(median_mpg_per_make$x,decreasing=T)[1:3],]

barplot1 <- ggplot(data=top_mean, aes(x=Group.1, y=x)) +
  geom_bar(stat="identity", fill="steelblue") + 
  xlab("Maker") +
  ylab("Avg. MPG") +
  ggtitle("Top Avg. MPG Makers")
# print(barplot1)

barplot2 <- ggplot(data=top_median, aes(x=Group.1, y=x)) +
  geom_bar(stat="identity", fill="steelblue") + 
  xlab("Maker") +
  ylab("Median MPG") +
  ggtitle("Top Median MPG Makers")
# print(barplot2)

multiplot(barplot1, barplot2, cols =2)

print(paste0(top_mean[1,1], paste0(" has the most fuel efficient fleet with average MPG as ", round(top_mean[1,2],2))))

```

## Correlation Analysis
Checking for corelations between different variables. 

```{r}
numeric_features <- c('cylinders', 'displ', 'UCity')
vehicles_numeric_data <- vehicles_desired[, names(vehicles_desired) %in% numeric_features]

correlations <- cor(vehicles_numeric_data)
corrplot(correlations)
```

The two numeric features, cylinders and displ, both are well correlated with target UCity (MPG) but also highly correlated with each other as seen from the above correlation graph. So, one of the two varibale might be required to be removed depending on Variance Inflation Factor of final model.

## Other Trends

```{r}
#Subsetting for only top 3 manufacturers as our previous analysis
vehicles_trends <- vehicles_desired[vehicles_desired$make %in% c("Honda", "Hyundai", "Mitsubishi"),]

mean_mpg <- aggregate( UCity ~ make + year, data = vehicles_trends, mean)
plot1 <- ggplot(data = mean_mpg, aes(x=year, y=UCity, colour = make)) +
  geom_line(aes(group = make)) +
  geom_smooth(method = 'loess', linetype = 2) +
  ggtitle("Mean MPG Trends for Three Manufacturers")
plot1
```

As seen from the graph, the average MPG is generally going up for the shown manufacturers since 2005, probably because of external factors like recent push from authorities to reduce fuel consumption or rising fuel costs. The future MPG thus should be higher than current values. One can further explore this with a time series model.

